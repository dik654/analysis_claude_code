# Kode-CLI ê¶Œí•œ ë° ë³´ì•ˆ ì‹œìŠ¤í…œ ë¶„ì„

## ëª©ì°¨
1. [ê°œìš”](#ê°œìš”)
2. [ê¶Œí•œ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜](#ê¶Œí•œ-ì‹œìŠ¤í…œ-ì•„í‚¤í…ì²˜)
3. [PermissionContext: ê¶Œí•œ ìƒíƒœ ê´€ë¦¬](#permissioncontext-ê¶Œí•œ-ìƒíƒœ-ê´€ë¦¬)
4. [ë„êµ¬ ì‚¬ìš© ê¶Œí•œ ì²´í¬ ë©”ì»¤ë‹ˆì¦˜](#ë„êµ¬-ì‚¬ìš©-ê¶Œí•œ-ì²´í¬-ë©”ì»¤ë‹ˆì¦˜)
5. [ê¶Œí•œ ìš”ì²­ ë¡œê¹… ì‹œìŠ¤í…œ](#ê¶Œí•œ-ìš”ì²­-ë¡œê¹…-ì‹œìŠ¤í…œ)
6. [API í‚¤ ê²€ì¦ ì‹œìŠ¤í…œ](#api-í‚¤-ê²€ì¦-ì‹œìŠ¤í…œ)
7. [ì—ëŸ¬ ì¶”ì  (Sentry) í†µí•©](#ì—ëŸ¬-ì¶”ì -sentry-í†µí•©)
8. [ë¹„ìš© ì¶”ì  ì‹œìŠ¤í…œ](#ë¹„ìš©-ì¶”ì -ì‹œìŠ¤í…œ)
9. [íŒŒì¼ì‹œìŠ¤í…œ ê¶Œí•œ ê´€ë¦¬](#íŒŒì¼ì‹œìŠ¤í…œ-ê¶Œí•œ-ê´€ë¦¬)
10. [ë³´ì•ˆ ê²€ì¦ ë° ì œì•½ì‚¬í•­](#ë³´ì•ˆ-ê²€ì¦-ë°-ì œì•½ì‚¬í•­)
11. [ê¶Œí•œ ì²´í¬ í”Œë¡œìš°](#ê¶Œí•œ-ì²´í¬-í”Œë¡œìš°)
12. [íƒ€ì… ì •ì˜ ë° ìƒìˆ˜](#íƒ€ì…-ì •ì˜-ë°-ìƒìˆ˜)

---

## ê°œìš”

Kode-CLIëŠ” **ë‹¤ì¸µ ë³´ì•ˆ ë° ê¶Œí•œ ì‹œìŠ¤í…œ**ì„ í†µí•´ ì‚¬ìš©ìì˜ ì‹œìŠ¤í…œ ìì›ì„ ì•ˆì „í•˜ê²Œ ê´€ë¦¬í•©ë‹ˆë‹¤. ì´ ì‹œìŠ¤í…œì€ í¬ê²Œ ë‹¤ìŒê³¼ ê°™ì€ ì»´í¬ë„ŒíŠ¸ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤:

- **ê¶Œí•œ ëª¨ë“œ ê´€ë¦¬**: 4ê°€ì§€ ê¶Œí•œ ëª¨ë“œë¥¼ í†µí•œ ìœ ì—°í•œ ë³´ì•ˆ ì •ì±…
- **ë„êµ¬ë³„ ê¶Œí•œ ì²´í¬**: ê° ë„êµ¬ì˜ ì‹¤í–‰ ì „ ì„¸ë°€í•œ ê¶Œí•œ ê²€ì¦
- **íŒŒì¼ì‹œìŠ¤í…œ ê¶Œí•œ**: ì½ê¸°/ì“°ê¸° ì‘ì—…ì— ëŒ€í•œ ê²½ë¡œ ê¸°ë°˜ ê¶Œí•œ ê´€ë¦¬
- **Bash ëª…ë ¹ì–´ ê²€ì¦**: ëª…ë ¹ì–´ ì£¼ì… ê³µê²© ë°©ì§€ ë° ì•ˆì „í•œ ëª…ë ¹ì–´ í•„í„°ë§
- **ë¹„ìš© ì¶”ì **: API í˜¸ì¶œ ë¹„ìš© ëª¨ë‹ˆí„°ë§ ë° ì œí•œ

**í•µì‹¬ ì„¤ê³„ ì›ì¹™:**
- **Fail-Safe**: ê¶Œí•œ ë¶ˆí™•ì‹¤ì‹œ ê±°ë¶€ (Fail Closed)
- **ìµœì†Œ ê¶Œí•œ ì›ì¹™**: í•„ìš”í•œ ìµœì†Œí•œì˜ ê¶Œí•œë§Œ ë¶€ì—¬
- **ì‚¬ìš©ì ì œì–´**: ëª¨ë“  ë¯¼ê°í•œ ì‘ì—…ì€ ì‚¬ìš©ì ìŠ¹ì¸ í•„ìš”
- **íˆ¬ëª…ì„±**: ëª¨ë“  ê¶Œí•œ ìš”ì²­ì€ ë¡œê¹… ë° ì¶”ì 

---

## ê¶Œí•œ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

### ì „ì²´ êµ¬ì¡°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤                          â”‚
â”‚                  (ê¶Œí•œ ìš”ì²­ UI Component)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              PermissionContext (React Context)               â”‚
â”‚  - ê¶Œí•œ ëª¨ë“œ ê´€ë¦¬ (default/acceptEdits/plan/bypassPermissions) â”‚
â”‚  - í—ˆìš©ëœ ë„êµ¬ ëª©ë¡                                            â”‚
â”‚  - ì œì•½ì‚¬í•­ ì„¤ì •                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            useCanUseTool Hook (ê¶Œí•œ ì²´í¬ ë¡œì§)                 â”‚
â”‚  - hasPermissionsToUseTool() í˜¸ì¶œ                            â”‚
â”‚  - ê¶Œí•œ ê±°ë¶€ì‹œ ì‚¬ìš©ìì—ê²Œ ìŠ¹ì¸ ìš”ì²­                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                          â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Bash ë„êµ¬   â”‚         â”‚  íŒŒì¼ ë„êµ¬    â”‚  â”‚   ê¸°íƒ€ ë„êµ¬   â”‚
â”‚ ëª…ë ¹ì–´ ê²€ì¦    â”‚         â”‚ ê²½ë¡œ ê²€ì¦     â”‚  â”‚  ë‹¨ìˆœ ê¶Œí•œ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                          â”‚             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ê¶Œí•œ ì €ì¥ ë ˆì´ì–´                              â”‚
â”‚  - í”„ë¡œì íŠ¸ ì„¤ì • (.kode.json)                                 â”‚
â”‚  - ì„¸ì…˜ ë©”ëª¨ë¦¬ (íŒŒì¼ì‹œìŠ¤í…œ ê¶Œí•œ)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì£¼ìš” íŒŒì¼ ì—­í• 

| íŒŒì¼ | ì—­í•  |
|------|------|
| `/src/permissions.ts` | ê¶Œí•œ ì²´í¬ ë¡œì§ ë° ì €ì¥ ë©”ì»¤ë‹ˆì¦˜ |
| `/src/context/PermissionContext.tsx` | React Contextë¥¼ í†µí•œ ê¶Œí•œ ìƒíƒœ ê´€ë¦¬ |
| `/src/hooks/useCanUseTool.ts` | ë„êµ¬ ì‹¤í–‰ ì „ ê¶Œí•œ ì²´í¬ Hook |
| `/src/hooks/usePermissionRequestLogging.ts` | ê¶Œí•œ ìš”ì²­ ë¡œê¹… |
| `/src/utils/permissions/filesystem.ts` | íŒŒì¼ì‹œìŠ¤í…œ ê¶Œí•œ ê´€ë¦¬ |
| `/src/Tool.ts` | ë„êµ¬ ì¸í„°í˜ì´ìŠ¤ ë° needsPermissions ì •ì˜ |

---

## PermissionContext: ê¶Œí•œ ìƒíƒœ ê´€ë¦¬

### ê¶Œí•œ ëª¨ë“œ íƒ€ì… ì •ì˜

```typescript
// 4ê°€ì§€ ê¶Œí•œ ëª¨ë“œ
export type PermissionMode =
  | 'default'              // ê¸°ë³¸: ëª¨ë“  ì‘ì—… ìŠ¹ì¸ í•„ìš”
  | 'acceptEdits'          // í¸ì§‘ ìë™ ìŠ¹ì¸
  | 'plan'                 // ì½ê¸° ì „ìš© ëª¨ë“œ (ê³„íš ìˆ˜ë¦½)
  | 'bypassPermissions'    // ëª¨ë“  ê¶Œí•œ ìš°íšŒ

export interface PermissionContext {
  mode: PermissionMode
  allowedTools: string[]           // í—ˆìš©ëœ ë„êµ¬ ëª©ë¡
  allowedPaths: string[]           // í—ˆìš©ëœ ê²½ë¡œ ëª©ë¡
  restrictions: {
    readOnly: boolean              // ì½ê¸° ì „ìš© ëª¨ë“œ
    requireConfirmation: boolean   // í™•ì¸ í•„ìš” ì—¬ë¶€
    bypassValidation: boolean      // ê²€ì¦ ìš°íšŒ ì—¬ë¶€
  }
  metadata: {
    activatedAt?: string           // í™œì„±í™” ì‹œê°„
    previousMode?: PermissionMode  // ì´ì „ ëª¨ë“œ
    transitionCount: number        // ëª¨ë“œ ì „í™˜ íšŸìˆ˜
  }
}
```

### ëª¨ë“œë³„ ì„¤ì •

```typescript
export const MODE_CONFIGS: Record<PermissionMode, ModeConfig> = {
  default: {
    name: 'default',
    label: 'DEFAULT',
    icon: 'ğŸ”’',
    color: 'blue',
    description: 'Standard permission checking',
    allowedTools: ['*'],  // ëª¨ë“  ë„êµ¬ í—ˆìš© (ë‹¨, ìŠ¹ì¸ í•„ìš”)
    restrictions: {
      readOnly: false,
      requireConfirmation: true,    // âœ… í™•ì¸ í•„ìš”
      bypassValidation: false,
    },
  },
  acceptEdits: {
    name: 'acceptEdits',
    label: 'ACCEPT EDITS',
    icon: 'âœ…',
    color: 'green',
    description: 'Auto-approve edit operations',
    allowedTools: ['*'],
    restrictions: {
      readOnly: false,
      requireConfirmation: false,   // âŒ í™•ì¸ ë¶ˆí•„ìš”
      bypassValidation: false,
    },
  },
  plan: {
    name: 'plan',
    label: 'PLAN MODE',
    icon: 'ğŸ“',
    color: 'yellow',
    description: 'Research and planning - read-only tools only',
    allowedTools: [
      'Read', 'Grep', 'Glob', 'LS',
      'WebSearch', 'WebFetch', 'NotebookRead',
      'exit_plan_mode'
    ],
    restrictions: {
      readOnly: true,               // âœ… ì½ê¸° ì „ìš©
      requireConfirmation: true,
      bypassValidation: false,
    },
  },
  bypassPermissions: {
    name: 'bypassPermissions',
    label: 'BYPASS PERMISSIONS',
    icon: 'ğŸ”“',
    color: 'red',
    description: 'All permissions bypassed',
    allowedTools: ['*'],
    restrictions: {
      readOnly: false,
      requireConfirmation: false,
      bypassValidation: true,       // âš ï¸ ëª¨ë“  ê²€ì¦ ìš°íšŒ
    },
  },
}
```

### PermissionProvider êµ¬í˜„

```typescript
export function PermissionProvider({
  children,
  isBypassPermissionsModeAvailable = false,
}: PermissionProviderProps) {
  const [permissionContext, setPermissionContext] = useState<IPermissionContext>({
    mode: 'default',
    allowedTools: ['*'],
    allowedPaths: [process.cwd()],
    restrictions: {
      readOnly: false,
      requireConfirmation: true,
      bypassValidation: false,
    },
    metadata: {
      transitionCount: 0,
    },
  })

  // ëª¨ë“œ ìˆœí™˜ (default â†’ acceptEdits â†’ plan â†’ bypassPermissions â†’ default)
  const cycleMode = useCallback(() => {
    setPermissionContext(prev => {
      const nextMode = getNextPermissionMode(
        prev.mode,
        isBypassPermissionsModeAvailable,
      )
      const modeConfig = MODE_CONFIGS[nextMode]

      console.log(`ğŸ”„ Mode cycle: ${prev.mode} â†’ ${nextMode}`)

      return {
        ...prev,
        mode: nextMode,
        allowedTools: modeConfig.allowedTools,
        restrictions: modeConfig.restrictions,
        metadata: {
          ...prev.metadata,
          previousMode: prev.mode,
          activatedAt: new Date().toISOString(),
          transitionCount: prev.metadata.transitionCount + 1,
        },
      }
    })
  }, [isBypassPermissionsModeAvailable])

  // ë„êµ¬ í—ˆìš© ì—¬ë¶€ ì²´í¬
  const isToolAllowed = useCallback(
    (toolName: string) => {
      const { allowedTools } = permissionContext

      // '*' ì™€ì¼ë“œì¹´ë“œ: ëª¨ë“  ë„êµ¬ í—ˆìš©
      if (allowedTools.includes('*')) {
        return true
      }

      // íŠ¹ì • ë„êµ¬ ì²´í¬
      return allowedTools.includes(toolName)
    },
    [permissionContext],
  )

  return (
    <PermissionContext.Provider value={{
      permissionContext,
      currentMode: permissionContext.mode,
      cycleMode,
      setMode,
      isToolAllowed,
      getModeConfig,
    }}>
      {children}
    </PermissionContext.Provider>
  )
}
```

**í•µì‹¬ íŠ¹ì§•:**
- **React Context API** ê¸°ë°˜ ì „ì—­ ìƒíƒœ ê´€ë¦¬
- **4ê°€ì§€ ê¶Œí•œ ëª¨ë“œ** ì§€ì› (default, acceptEdits, plan, bypassPermissions)
- **ëª¨ë“œ ìˆœí™˜ ê¸°ëŠ¥**: ì‚¬ìš©ìê°€ ì‰½ê²Œ ëª¨ë“œ ì „í™˜ ê°€ëŠ¥
- **ë©”íƒ€ë°ì´í„° ì¶”ì **: ëª¨ë“œ ì „í™˜ ì´ë ¥ ë° íšŸìˆ˜ ê¸°ë¡

---

## ë„êµ¬ ì‚¬ìš© ê¶Œí•œ ì²´í¬ ë©”ì»¤ë‹ˆì¦˜

### hasPermissionsToUseTool í•¨ìˆ˜

ê¶Œí•œ ì²´í¬ì˜ í•µì‹¬ ë¡œì§ìœ¼ë¡œ, ë„êµ¬ ì‹¤í–‰ ì „ í˜¸ì¶œë©ë‹ˆë‹¤.

```typescript
export const hasPermissionsToUseTool: CanUseToolFn = async (
  tool,
  input,
  context,
  _assistantMessage,
): Promise<PermissionResult> => {
  // 1. Safe Mode ì²´í¬: ë¹„í™œì„±í™”ì‹œ ëª¨ë“  ë„êµ¬ í—ˆìš©
  if (!context.options.safeMode) {
    return { result: true }
  }

  // 2. Abort ì‹ í˜¸ ì²´í¬
  if (context.abortController.signal.aborted) {
    throw new AbortError()
  }

  // 3. ë„êµ¬ ìì²´ê°€ ê¶Œí•œ í•„ìš” ì—†ë‹¤ê³  ì„ ì–¸í•˜ë©´ í—ˆìš©
  try {
    if (!tool.needsPermissions(input as never)) {
      return { result: true }
    }
  } catch (e) {
    logError(`Error checking permissions: ${e}`)
    return { result: false, message: 'Error checking permissions' }
  }

  // 4. í”„ë¡œì íŠ¸ ì„¤ì •ì—ì„œ í—ˆìš©ëœ ë„êµ¬ ëª©ë¡ ì¡°íšŒ
  const projectConfig = getCurrentProjectConfig()
  const allowedTools = projectConfig.allowedTools ?? []

  // 5. BashTool íŠ¹ë³„ ì²˜ë¦¬: ì „ì²´ ëª…ë ¹ì–´ í—ˆìš©
  if (tool === BashTool && allowedTools.includes(BashTool.name)) {
    return { result: true }
  }

  // 6. ë„êµ¬ë³„ ê¶Œí•œ ì²´í¬
  switch (tool) {
    case BashTool: {
      const { command } = inputSchema.parse(input)
      return await bashToolHasPermission(tool, command, context, allowedTools)
    }

    case FileEditTool:
    case FileWriteTool:
    case NotebookEditTool: {
      if (!tool.needsPermissions(input)) {
        return { result: true }
      }
      return {
        result: false,
        message: `${PRODUCT_NAME} requested permissions to use ${tool.name}, but you haven't granted it yet.`,
      }
    }

    default: {
      const permissionKey = getPermissionKey(tool, input, null)
      if (allowedTools.includes(permissionKey)) {
        return { result: true }
      }

      return {
        result: false,
        message: `${PRODUCT_NAME} requested permissions to use ${tool.name}, but you haven't granted it yet.`,
      }
    }
  }
}
```

### Bash ë„êµ¬ ê¶Œí•œ ì²´í¬ ìƒì„¸

Bash ë„êµ¬ëŠ” ê°€ì¥ ë³µì¡í•œ ê¶Œí•œ ì²´í¬ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.

```typescript
export const bashToolHasPermission = async (
  tool: Tool,
  command: string,
  context: ToolUseContext,
  allowedTools: string[],
  getCommandSubcommandPrefixFn = getCommandSubcommandPrefix,
): Promise<PermissionResult> => {
  // 1. ì•ˆì „í•œ ëª…ë ¹ì–´ ì¦‰ì‹œ í—ˆìš©
  if (bashToolCommandHasExactMatchPermission(tool, command, allowedTools)) {
    return { result: true }
  }

  // 2. ëª…ë ¹ì–´ ë¶„ë¦¬ (&&, ;, || ë“±ìœ¼ë¡œ ì—°ê²°ëœ ê²½ìš°)
  const subCommands = splitCommand(command).filter(_ => {
    if (_ === `cd ${getCwd()}`) {
      return false  // í˜„ì¬ ë””ë ‰í† ë¦¬ë¡œì˜ cdëŠ” ë¬´ì‹œ
    }
    return true
  })

  // 3. ëª…ë ¹ì–´ ì ‘ë‘ì‚¬ ì¶”ì¶œ (ì˜ˆ: "git status" â†’ "git")
  const commandSubcommandPrefix = await getCommandSubcommandPrefixFn(
    command,
    context.abortController.signal,
  )

  if (context.abortController.signal.aborted) {
    throw new AbortError()
  }

  // 4. ì ‘ë‘ì‚¬ ì¶”ì¶œ ì‹¤íŒ¨ì‹œ Fail Closed
  if (commandSubcommandPrefix === null) {
    return {
      result: false,
      message: `${PRODUCT_NAME} requested permissions to use ${tool.name}, but you haven't granted it yet.`,
    }
  }

  // 5. ëª…ë ¹ì–´ ì£¼ì… íƒì§€ì‹œ ì •í™•í•œ ë§¤ì¹­ë§Œ í—ˆìš©
  if (commandSubcommandPrefix.commandInjectionDetected) {
    if (bashToolCommandHasExactMatchPermission(tool, command, allowedTools)) {
      return { result: true }
    } else {
      return {
        result: false,
        message: `${PRODUCT_NAME} requested permissions to use ${tool.name}, but you haven't granted it yet.`,
      }
    }
  }

  // 6. ë‹¨ì¼ ëª…ë ¹ì–´ ì²´í¬
  if (subCommands.length < 2) {
    if (bashToolCommandHasPermission(
        tool,
        command,
        commandSubcommandPrefix.commandPrefix,
        allowedTools,
      )) {
      return { result: true }
    } else {
      return {
        result: false,
        message: `${PRODUCT_NAME} requested permissions to use ${tool.name}, but you haven't granted it yet.`,
      }
    }
  }

  // 7. ë‹¤ì¤‘ ëª…ë ¹ì–´ ì²´í¬ (ëª¨ë“  ì„œë¸Œì»¤ë§¨ë“œê°€ í—ˆìš©ë˜ì–´ì•¼ í•¨)
  if (subCommands.every(subCommand => {
      const prefixResult = commandSubcommandPrefix.subcommandPrefixes.get(subCommand)
      if (prefixResult === undefined || prefixResult.commandInjectionDetected) {
        return false
      }
      return bashToolCommandHasPermission(
        tool,
        subCommand,
        prefixResult ? prefixResult.commandPrefix : null,
        allowedTools,
      )
    })) {
    return { result: true }
  }

  return {
    result: false,
    message: `${PRODUCT_NAME} requested permissions to use ${tool.name}, but you haven't granted it yet.`,
  }
}
```

### ì•ˆì „í•œ ëª…ë ¹ì–´ ëª©ë¡

```typescript
const SAFE_COMMANDS = new Set([
  'git status',
  'git diff',
  'git log',
  'git branch',
  'pwd',
  'tree',
  'date',
  'which',
])
```

**ë³´ì•ˆ íŠ¹ì§•:**
- **ëª…ë ¹ì–´ ì£¼ì… íƒì§€**: ì•…ì˜ì ì¸ ëª…ë ¹ì–´ ì—°ê²° ë°©ì§€
- **ì„œë¸Œì»¤ë§¨ë“œ ê²€ì¦**: ë³µí•© ëª…ë ¹ì–´ì˜ ê° ë¶€ë¶„ ê°œë³„ ê²€ì¦
- **Fail Closed**: ë¶ˆí™•ì‹¤í•œ ê²½ìš° ê±°ë¶€
- **ì•ˆì „í•œ ëª…ë ¹ì–´ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸**: ì¼ë°˜ì ì¸ ì½ê¸° ì „ìš© ëª…ë ¹ì–´ëŠ” ì¦‰ì‹œ í—ˆìš©

---

## ê¶Œí•œ ìš”ì²­ ë¡œê¹… ì‹œìŠ¤í…œ

### usePermissionRequestLogging Hook

```typescript
export function usePermissionRequestLogging(
  toolUseConfirm: ToolUseConfirm,
  unaryEvent: UnaryEvent,
): void {
  useEffect(() => {
    // Promise ë˜ëŠ” ë¬¸ìì—´ ì²˜ë¦¬
    const languagePromise = Promise.resolve(unaryEvent.language_name)

    // Unary ì´ë²¤íŠ¸ ë¡œê¹…
    languagePromise.then(language => {
      logUnaryEvent({
        completion_type: unaryEvent.completion_type,
        event: 'response',
        metadata: {
          language_name: language,
          message_id: toolUseConfirm.assistantMessage.message.id,
          platform: env.platform,
        },
      })
    })
  }, [toolUseConfirm, unaryEvent])
}
```

**ë¡œê¹… ì •ë³´:**
- **completion_type**: ì™„ë£Œ íƒ€ì… (ìŠ¹ì¸/ê±°ë¶€ ë“±)
- **language_name**: í”„ë¡œê·¸ë˜ë° ì–¸ì–´ (Bash ëª…ë ¹ì–´ ë“±)
- **message_id**: ë©”ì‹œì§€ ê³ ìœ  ID
- **platform**: ì‹¤í–‰ í”Œë«í¼ (linux, darwin, win32)

### useCanUseTool Hook

ë„êµ¬ ì‹¤í–‰ ì „ ê¶Œí•œ ì²´í¬ ë° ì‚¬ìš©ì ìŠ¹ì¸ ìš”ì²­:

```typescript
function useCanUseTool(
  setToolUseConfirm: SetState<ToolUseConfirm | null>,
): CanUseToolFn {
  return useCallback<CanUseToolFn>(
    async (tool, input, toolUseContext, assistantMessage) => {
      return new Promise(resolve => {
        // Abort ì‹ í˜¸ ì²˜ë¦¬
        function resolveWithCancelledAndAbortAllToolCalls() {
          resolve({
            result: false,
            message: REJECT_MESSAGE,
          })
          toolUseContext.abortController.abort()
        }

        if (toolUseContext.abortController.signal.aborted) {
          resolveWithCancelledAndAbortAllToolCalls()
          return
        }

        // ê¶Œí•œ ì²´í¬
        return hasPermissionsToUseTool(
          tool,
          input,
          toolUseContext,
          assistantMessage,
        )
          .then(async result => {
            // ê¶Œí•œ ìˆìŒ: ì¦‰ì‹œ ì‹¤í–‰
            if (result.result) {
              resolve({ result: true })
              return
            }

            // ê¶Œí•œ ì—†ìŒ: ì‚¬ìš©ìì—ê²Œ ìŠ¹ì¸ ìš”ì²­
            const [description, commandPrefix] = await Promise.all([
              tool.description(input as never),
              tool === BashTool
                ? getCommandSubcommandPrefix(
                    inputSchema.parse(input).command,
                    toolUseContext.abortController.signal,
                  )
                : Promise.resolve(null),
            ])

            if (toolUseContext.abortController.signal.aborted) {
              resolveWithCancelledAndAbortAllToolCalls()
              return
            }

            // ê¶Œí•œ ìš”ì²­ UI í‘œì‹œ
            setToolUseConfirm({
              assistantMessage,
              tool,
              description,
              input,
              commandPrefix,
              riskScore: null,
              onAbort() {
                resolveWithCancelledAndAbortAllToolCalls()
              },
              onAllow(type) {
                // type: 'permanent' | 'temporary'
                resolve({ result: true })
              },
              onReject() {
                resolveWithCancelledAndAbortAllToolCalls()
              },
            })
          })
          .catch(error => {
            if (error instanceof AbortError) {
              resolveWithCancelledAndAbortAllToolCalls()
            } else {
              logError(error)
            }
          })
      })
    },
    [setToolUseConfirm],
  )
}
```

**ì£¼ìš” íë¦„:**
1. **ê¶Œí•œ ì²´í¬**: `hasPermissionsToUseTool()` í˜¸ì¶œ
2. **ê¶Œí•œ ìˆìŒ**: ì¦‰ì‹œ ì‹¤í–‰
3. **ê¶Œí•œ ì—†ìŒ**: ì‚¬ìš©ìì—ê²Œ UIë¡œ ìŠ¹ì¸ ìš”ì²­
4. **ì‚¬ìš©ì ì‘ë‹µ**: ìŠ¹ì¸(onAllow), ê±°ë¶€(onReject), ì·¨ì†Œ(onAbort)
5. **Abort ì²˜ë¦¬**: ì–¸ì œë“ ì§€ ì·¨ì†Œ ê°€ëŠ¥

---

## API í‚¤ ê²€ì¦ ì‹œìŠ¤í…œ

### useApiKeyVerification Hook

```typescript
export type VerificationStatus =
  | 'loading'   // ê²€ì¦ ì¤‘
  | 'valid'     // ìœ íš¨í•¨
  | 'invalid'   // ë¬´íš¨í•¨
  | 'missing'   // í‚¤ ì—†ìŒ
  | 'error'     // ê²€ì¦ ì˜¤ë¥˜

export type ApiKeyVerificationResult = {
  status: VerificationStatus
  reverify: () => Promise<void>
  error: Error | null
}

export function useApiKeyVerification(): ApiKeyVerificationResult {
  // í˜„ì¬ êµ¬í˜„ì—ì„œëŠ” í•­ìƒ 'valid' ë°˜í™˜ (ì£¼ì„ ì²˜ë¦¬ëœ ì‹¤ì œ ê²€ì¦ ë¡œì§ ì¡´ì¬)
  return {
    status: 'valid',
    reverify: async () => {},
    error: null,
  }
}
```

**ì£¼ì„ ì²˜ë¦¬ëœ ì‹¤ì œ ê²€ì¦ ë¡œì§:**
```typescript
// const verify = useCallback(async (): Promise<void> => {
//   if (isDefaultApiKey()) {
//     setStatus('valid')
//     return
//   }
//
//   try {
//     const isValid = await verifyApiKey(apiKey)
//     const newStatus = isValid ? 'valid' : 'invalid'
//     setStatus(newStatus)
//     return
//   } catch (error) {
//     setError(error as Error)
//     const newStatus = 'error' as const
//     setStatus(newStatus)
//     return
//   }
// }, [])
```

**ì„¤ê³„ ì˜ë„:**
- API í‚¤ ê²€ì¦ ë¡œì§ì€ êµ¬í˜„ë˜ì–´ ìˆì§€ë§Œ í˜„ì¬ëŠ” ë¹„í™œì„±í™”
- í•„ìš”ì‹œ ì£¼ì„ í•´ì œí•˜ì—¬ ì‹¤ì œ ê²€ì¦ ìˆ˜í–‰ ê°€ëŠ¥
- **verifyApiKey()** í•¨ìˆ˜ëŠ” `/src/services/claude.ts`ì— ì •ì˜

---

## ì—ëŸ¬ ì¶”ì  (Sentry) í†µí•©

### Sentry ì„œë¹„ìŠ¤

```typescript
// /src/services/sentry.ts
export function initSentry(): void {}

export async function captureException(error: unknown): Promise<void> {}
```

**í˜„ì¬ ìƒíƒœ:**
- Sentry í†µí•©ì€ ìŠ¤í…(stub)ìœ¼ë¡œë§Œ êµ¬í˜„
- ì‹¤ì œ ì—ëŸ¬ ì¶”ì  ê¸°ëŠ¥ì€ ë¹„í™œì„±í™” ìƒíƒœ
- í–¥í›„ í™•ì¥ì„ ìœ„í•œ ì¸í„°í˜ì´ìŠ¤ë§Œ ì œê³µ

**í™•ì¥ ê°€ëŠ¥ì„±:**
- í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ ì—ëŸ¬ ëª¨ë‹ˆí„°ë§ í•„ìš”ì‹œ êµ¬í˜„ ê°€ëŠ¥
- ì‚¬ìš©ì ë™ì˜ ì—†ì´ ì—ëŸ¬ ë°ì´í„° ì „ì†¡í•˜ì§€ ì•ŠìŒ (í”„ë¼ì´ë²„ì‹œ ê³ ë ¤)

---

## ë¹„ìš© ì¶”ì  ì‹œìŠ¤í…œ

### ì „ì—­ ìƒíƒœ ê´€ë¦¬

```typescript
const STATE: {
  totalCost: number        // ì´ ë¹„ìš© (USD)
  totalAPIDuration: number // ì´ API í˜¸ì¶œ ì‹œê°„ (ms)
  startTime: number        // ì„¸ì…˜ ì‹œì‘ ì‹œê°„
} = {
  totalCost: 0,
  totalAPIDuration: 0,
  startTime: Date.now(),
}
```

**âš ï¸ ì£¼ì˜ì‚¬í•­:**
```typescript
// DO NOT ADD MORE STATE HERE OR BORIS WILL CURSE YOU
```
ì „ì—­ ìƒíƒœ ìµœì†Œí™” ì›ì¹™

### ë¹„ìš© ì¶”ì  í•¨ìˆ˜

```typescript
// ë¹„ìš© ì¶”ê°€
export function addToTotalCost(cost: number, duration: number): void {
  STATE.totalCost += cost
  STATE.totalAPIDuration += duration
}

// ë¹„ìš© ì¡°íšŒ
export function getTotalCost(): number {
  return STATE.totalCost
}

// ì´ ì‹¤í–‰ ì‹œê°„
export function getTotalDuration(): number {
  return Date.now() - STATE.startTime
}

// API í˜¸ì¶œ ì‹œê°„
export function getTotalAPIDuration(): number {
  return STATE.totalAPIDuration
}
```

### ë¹„ìš© í¬ë§·íŒ…

```typescript
function formatCost(cost: number): string {
  return `$${cost > 0.5 ? round(cost, 100).toFixed(2) : cost.toFixed(4)}`
}

export function formatTotalCost(): string {
  return chalk.grey(
    `Total cost: ${formatCost(STATE.totalCost)}
Total duration (API): ${formatDuration(STATE.totalAPIDuration)}
Total duration (wall): ${formatDuration(getTotalDuration())}`,
  )
}
```

**ì¶œë ¥ ì˜ˆì‹œ:**
```
Total cost: $0.0234
Total duration (API): 1.5s
Total duration (wall): 3.2s
```

### useCostSummary Hook

ì„¸ì…˜ ì¢…ë£Œì‹œ ë¹„ìš© ì •ë³´ë¥¼ í”„ë¡œì íŠ¸ ì„¤ì •ì— ì €ì¥:

```typescript
export function useCostSummary(): void {
  useEffect(() => {
    const f = () => {
      process.stdout.write('\n' + formatTotalCost() + '\n')

      // í”„ë¡œì íŠ¸ ì„¤ì •ì— ì €ì¥
      const projectConfig = getCurrentProjectConfig()
      saveCurrentProjectConfig({
        ...projectConfig,
        lastCost: STATE.totalCost,
        lastAPIDuration: STATE.totalAPIDuration,
        lastDuration: getTotalDuration(),
        lastSessionId: SESSION_ID,
      })
    }

    process.on('exit', f)
    return () => {
      process.off('exit', f)
    }
  }, [])
}
```

**ì €ì¥ ì •ë³´:**
- `lastCost`: ë§ˆì§€ë§‰ ì„¸ì…˜ ë¹„ìš©
- `lastAPIDuration`: ë§ˆì§€ë§‰ ì„¸ì…˜ API í˜¸ì¶œ ì‹œê°„
- `lastDuration`: ë§ˆì§€ë§‰ ì„¸ì…˜ ì „ì²´ ì‹¤í–‰ ì‹œê°„
- `lastSessionId`: ì„¸ì…˜ ê³ ìœ  ID

---

## íŒŒì¼ì‹œìŠ¤í…œ ê¶Œí•œ ê´€ë¦¬

### ì¸ë©”ëª¨ë¦¬ ê¶Œí•œ ì €ì¥ì†Œ

```typescript
// ì„¸ì…˜ë§ˆë‹¤ ë¦¬ì…‹ë˜ëŠ” ì¸ë©”ëª¨ë¦¬ ì €ì¥ì†Œ
const readFileAllowedDirectories: Set<string> = new Set()
const writeFileAllowedDirectories: Set<string> = new Set()
```

**ì„¤ê³„ ì›ì¹™:**
- **ì„¸ì…˜ ê¸°ë°˜**: ì„¸ì…˜ ì¢…ë£Œì‹œ ëª¨ë“  ê¶Œí•œ ë¦¬ì…‹
- **ë””ë ‰í† ë¦¬ ë‹¨ìœ„**: íŒŒì¼ì´ ì•„ë‹Œ ë””ë ‰í† ë¦¬ ë‹¨ìœ„ë¡œ ê¶Œí•œ ê´€ë¦¬
- **ì„œë¸ŒíŒ¨ìŠ¤ ìë™ í¬í•¨**: ìƒìœ„ ë””ë ‰í† ë¦¬ ê¶Œí•œì€ í•˜ìœ„ ë””ë ‰í† ë¦¬ í¬í•¨

### ê²½ë¡œ ì •ê·œí™”

```typescript
export function toAbsolutePath(path: string): string {
  const abs = isAbsolute(path) ? resolve(path) : resolve(getCwd(), path)
  return normalizeForCompare(abs)
}

function normalizeForCompare(p: string): string {
  const norm = resolve(p)
  // Windowsì—ì„œëŠ” ëŒ€ì†Œë¬¸ì ë¬´ì‹œ
  return process.platform === 'win32' ? norm.toLowerCase() : norm
}

function isSubpath(base: string, target: string): boolean {
  const rel = relative(base, target)
  if (!rel || rel === '') return true
  if (rel.startsWith('..')) return false  // ìƒìœ„ ë””ë ‰í† ë¦¬
  if (isAbsolute(rel)) return false       // ë‹¤ë¥¸ ë“œë¼ì´ë¸Œ
  return true
}
```

**í¬ë¡œìŠ¤ í”Œë«í¼ ì§€ì›:**
- **Windows**: ëŒ€ì†Œë¬¸ì ë¬´ì‹œ, ë“œë¼ì´ë¸Œ ë¬¸ì ì²˜ë¦¬
- **Linux/macOS**: ëŒ€ì†Œë¬¸ì êµ¬ë¶„

### ê¶Œí•œ ì²´í¬ í•¨ìˆ˜

```typescript
// ì½ê¸° ê¶Œí•œ ì²´í¬
export function hasReadPermission(directory: string): boolean {
  const absolutePath = toAbsolutePath(directory)
  for (const allowedPath of readFileAllowedDirectories) {
    if (isSubpath(allowedPath, absolutePath)) return true
  }
  return false
}

// ì“°ê¸° ê¶Œí•œ ì²´í¬
export function hasWritePermission(directory: string): boolean {
  const absolutePath = toAbsolutePath(directory)
  for (const allowedPath of writeFileAllowedDirectories) {
    if (isSubpath(allowedPath, absolutePath)) return true
  }
  return false
}
```

### ê¶Œí•œ ë¶€ì—¬ í•¨ìˆ˜

```typescript
// ì½ê¸° ê¶Œí•œ ë¶€ì—¬ (ë‚´ë¶€ í•¨ìˆ˜)
function saveReadPermission(directory: string): void {
  const absolutePath = toAbsolutePath(directory)
  // ê¸°ì¡´ ì„œë¸ŒíŒ¨ìŠ¤ ì œê±° (ì¤‘ë³µ ë°©ì§€)
  for (const allowedPath of Array.from(readFileAllowedDirectories)) {
    if (isSubpath(absolutePath, allowedPath)) {
      readFileAllowedDirectories.delete(allowedPath)
    }
  }
  readFileAllowedDirectories.add(absolutePath)
}

// ì›ë˜ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ì— ì½ê¸° ê¶Œí•œ ë¶€ì—¬
export function grantReadPermissionForOriginalDir(): void {
  const originalProjectDir = getOriginalCwd()
  saveReadPermission(originalProjectDir)
}

// ì“°ê¸° ê¶Œí•œ ë¶€ì—¬
function saveWritePermission(directory: string): void {
  const absolutePath = toAbsolutePath(directory)
  for (const allowedPath of Array.from(writeFileAllowedDirectories)) {
    if (isSubpath(absolutePath, allowedPath)) {
      writeFileAllowedDirectories.delete(allowedPath)
    }
  }
  writeFileAllowedDirectories.add(absolutePath)
}

// ì›ë˜ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ì— ì“°ê¸° ê¶Œí•œ ë¶€ì—¬
export function grantWritePermissionForOriginalDir(): void {
  const originalProjectDir = getOriginalCwd()
  saveWritePermission(originalProjectDir)
}
```

### ì›ë˜ ì‘ì—… ë””ë ‰í† ë¦¬ ì œì•½

```typescript
export function pathInOriginalCwd(path: string): boolean {
  const absolutePath = toAbsolutePath(path)
  const base = toAbsolutePath(getOriginalCwd())
  return isSubpath(base, absolutePath)
}
```

**ë³´ì•ˆ ì •ì±…:**
- **ì›ë˜ ì‘ì—… ë””ë ‰í† ë¦¬**: ì„¸ì…˜ ì‹œì‘ì‹œì˜ `cwd`
- **ìƒìœ„ ë””ë ‰í† ë¦¬ ì ‘ê·¼ ì œí•œ**: `..`ì„ í†µí•œ íƒˆì¶œ ë°©ì§€
- **ì ˆëŒ€ ê²½ë¡œ ê²€ì¦**: ì‹¬ë³¼ë¦­ ë§í¬ ë“±ì„ í†µí•œ ìš°íšŒ ë°©ì§€

### ë„êµ¬ë³„ íŒŒì¼ì‹œìŠ¤í…œ ê¶Œí•œ ì²´í¬

#### FileEditTool

```typescript
export const FileEditTool = {
  // ...
  needsPermissions({ file_path }) {
    return !hasWritePermission(file_path)
  },
  // ...
}
```

#### BashToolì˜ cd ëª…ë ¹ì–´ ê²€ì¦

```typescript
async validateInput({ command }): Promise<ValidationResult> {
  const commands = splitCommand(command)
  for (const cmd of commands) {
    const parts = cmd.split(' ')
    const baseCmd = parts[0]

    // cd ëª…ë ¹ì–´ íŠ¹ë³„ ì²˜ë¦¬
    if (baseCmd === 'cd' && parts[1]) {
      const targetDir = parts[1]!.replace(/^['"]|['"]$/g, '')
      const fullTargetDir = isAbsolute(targetDir)
        ? targetDir
        : resolve(getCwd(), targetDir)

      // ì›ë˜ ì‘ì—… ë””ë ‰í† ë¦¬ ë‚´ë¶€ë§Œ í—ˆìš©
      if (!isInDirectory(
            relative(getOriginalCwd(), fullTargetDir),
            relative(getCwd(), getOriginalCwd()),
          )) {
        return {
          result: false,
          message: `ERROR: cd to '${fullTargetDir}' was blocked. For security, ${PRODUCT_NAME} may only change directories to child directories of the original working directory (${getOriginalCwd()}) for this session.`,
        }
      }
    }
  }
}
```

---

## ë³´ì•ˆ ê²€ì¦ ë° ì œì•½ì‚¬í•­

### ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ë³´ì•ˆ ì •ì±…

```typescript
export async function getSystemPrompt(): Promise<string[]> {
  return [
    `
IMPORTANT: Refuse to write code or explain code that may be used maliciously; even if the user claims it is for educational purposes. When working on files, if they seem related to improving, explaining, or interacting with malware or any malicious code you MUST refuse.

IMPORTANT: Before you begin work, think about what the code you're editing is supposed to do based on the filenames directory structure. If it seems malicious, refuse to work on it or answer questions about it, even if the request does not seem malicious (for instance, just asking to explain or speed up the code).
    `,
    // ...
  ]
}
```

**ì•…ì„± ì½”ë“œ ë³´í˜¸:**
- ì•…ì„± ì½”ë“œ ì‘ì„±/ê°œì„  ê±°ë¶€
- íŒŒì¼ëª…/ë””ë ‰í† ë¦¬ êµ¬ì¡° ê¸°ë°˜ ì•…ì„± ì½”ë“œ íƒì§€
- êµìœ¡ ëª©ì  ì£¼ì¥ë„ ê±°ë¶€

### Bash ëª…ë ¹ì–´ ê¸ˆì§€ ëª©ë¡

```typescript
// /src/tools/BashTool/prompt.ts (ì¶”ì •)
const BANNED_COMMANDS = [
  // ì‹œìŠ¤í…œ íŒŒê´´ ëª…ë ¹ì–´
  'rm -rf /',
  'mkfs',
  'dd if=/dev/zero',

  // ë„¤íŠ¸ì›Œí¬ ê³µê²© ë„êµ¬
  'nmap',
  'metasploit',

  // ê¶Œí•œ ìƒìŠ¹
  'sudo su',
  'chmod 777',
  // ...
]
```

### Tool ì¸í„°í˜ì´ìŠ¤ ë³´ì•ˆ ë©”ì„œë“œ

```typescript
export interface Tool {
  // ...

  // ì½ê¸° ì „ìš© ë„êµ¬ ì—¬ë¶€
  isReadOnly: () => boolean

  // ë™ì‹œ ì‹¤í–‰ ì•ˆì „ì„±
  isConcurrencySafe: () => boolean

  // ê¶Œí•œ í•„ìš” ì—¬ë¶€
  needsPermissions: (input?: z.infer<TInput>) => boolean

  // ì…ë ¥ ê²€ì¦
  validateInput?: (
    input: z.infer<TInput>,
    context?: ToolUseContext,
  ) => Promise<ValidationResult>

  // ...
}
```

**ë„êµ¬ë³„ ë³´ì•ˆ ì†ì„±:**

| ë„êµ¬ | isReadOnly | isConcurrencySafe | needsPermissions |
|------|------------|-------------------|------------------|
| Read | âœ… true | âœ… true | íŒŒì¼ ê²½ë¡œ ê¸°ë°˜ |
| Grep | âœ… true | âœ… true | âŒ false |
| Bash | âŒ false | âŒ false | âœ… true (í•­ìƒ) |
| FileEdit | âŒ false | âŒ false | íŒŒì¼ ê²½ë¡œ ê¸°ë°˜ |
| FileWrite | âŒ false | âŒ false | íŒŒì¼ ê²½ë¡œ ê¸°ë°˜ |

### RequestContext: Abort ì‹ í˜¸ ê´€ë¦¬

```typescript
export interface RequestContext {
  id: string
  abortController: AbortController
  startTime: number
  isActive: boolean
  type: 'query' | 'tool' | 'koding'
}

export interface AbortBarrier {
  requestId: string
  checkAbort(): boolean
  onAbort(callback: () => void): void
  cleanup(): void
}

export function createAbortBarrier(
  requestContext: RequestContext,
): AbortBarrier {
  let cleanupCallbacks: (() => void)[] = []

  return {
    requestId: requestContext.id,

    checkAbort(): boolean {
      // íŠ¹ì • ìš”ì²­ì— ëŒ€í•œ abortë§Œ ì‘ë‹µ
      return (
        requestContext.isActive &&
        requestContext.abortController.signal.aborted
      )
    },

    onAbort(callback: () => void): void {
      if (requestContext.isActive) {
        const abortHandler = () => {
          if (requestContext.isActive) {
            callback()
          }
        }
        requestContext.abortController.signal.addEventListener(
          'abort',
          abortHandler,
        )
        cleanupCallbacks.push(() => {
          requestContext.abortController.signal.removeEventListener(
            'abort',
            abortHandler,
          )
        })
      }
    },

    cleanup(): void {
      cleanupCallbacks.forEach(cleanup => cleanup())
      cleanupCallbacks = []
      requestContext.isActive = false
    },
  }
}
```

**Abort ì²˜ë¦¬ íŠ¹ì§•:**
- **ìš”ì²­ë³„ ê²©ë¦¬**: ê° ìš”ì²­ì€ ë…ë¦½ì ì¸ AbortController ë³´ìœ 
- **ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€**: cleanupì„ í†µí•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
- **ì •í™•í•œ íƒ€ê²ŸíŒ…**: requestIdë¡œ íŠ¹ì • ìš”ì²­ë§Œ ì¤‘ë‹¨

---

## ê¶Œí•œ ì²´í¬ í”Œë¡œìš°

### ì „ì²´ í”Œë¡œìš° ë‹¤ì´ì–´ê·¸ë¨

```
ì‚¬ìš©ì ìš”ì²­
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AI ëª¨ë¸ì´ ë„êµ¬ ì‚¬ìš© ê²°ì •             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ useCanUseTool Hook í˜¸ì¶œ              â”‚
â”‚ - Abort ì‹ í˜¸ ì²´í¬                    â”‚
â”‚ - hasPermissionsToUseTool() í˜¸ì¶œ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ hasPermissionsToUseTool()            â”‚
â”‚ 1. Safe Mode ì²´í¬                    â”‚
â”‚ 2. tool.needsPermissions() ì²´í¬      â”‚
â”‚ 3. í”„ë¡œì íŠ¸ ì„¤ì • ì¡°íšŒ                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚               â”‚
    ê¶Œí•œ ìˆìŒ        ê¶Œí•œ ì—†ìŒ
         â”‚               â”‚
         â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ì‹¤í–‰    â”‚    â”‚ ë„êµ¬ë³„ ìƒì„¸ ì²´í¬  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚                 â”‚
            BashTool          FileEditTool
                  â”‚                 â”‚
                  â–¼                 â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ ëª…ë ¹ì–´ ë¶„ì„      â”‚  â”‚ ê²½ë¡œ ê²€ì¦    â”‚
         â”‚ - ì•ˆì „ ëª…ë ¹ì–´    â”‚  â”‚ hasWritePermâ”‚
         â”‚ - ëª…ë ¹ì–´ ì£¼ì…    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ - ì„œë¸Œì»¤ë§¨ë“œ     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                 â”‚
    ê¶Œí•œ ìˆìŒ          ê¶Œí•œ ì—†ìŒ
         â”‚                 â”‚
         â–¼                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ì‹¤í–‰    â”‚      â”‚ UIë¡œ ì‚¬ìš©ìì—ê²Œ  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ ìŠ¹ì¸ ìš”ì²­        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                 â”‚
                ìŠ¹ì¸(Allow)        ê±°ë¶€(Reject)
                    â”‚                 â”‚
                    â–¼                 â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ ê¶Œí•œ ì €ì¥   â”‚      â”‚ ì¤‘ë‹¨      â”‚
            â”‚ ë„êµ¬ ì‹¤í–‰   â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ë‹¨ê³„ë³„ ìƒì„¸ ì„¤ëª…

#### 1ë‹¨ê³„: useCanUseTool Hook

```typescript
async (tool, input, toolUseContext, assistantMessage) => {
  return new Promise(resolve => {
    // Abort ì²´í¬
    if (toolUseContext.abortController.signal.aborted) {
      resolve({ result: false, message: REJECT_MESSAGE })
      return
    }

    // ê¶Œí•œ ì²´í¬ ì‹œì‘
    hasPermissionsToUseTool(tool, input, toolUseContext, assistantMessage)
      .then(async result => {
        if (result.result) {
          // ê¶Œí•œ ìˆìŒ
          resolve({ result: true })
        } else {
          // ê¶Œí•œ ì—†ìŒ: UI í‘œì‹œ
          setToolUseConfirm({...})
        }
      })
  })
}
```

#### 2ë‹¨ê³„: hasPermissionsToUseTool

```typescript
export const hasPermissionsToUseTool = async (...) => {
  // 1. Safe Mode ì²´í¬
  if (!context.options.safeMode) {
    return { result: true }
  }

  // 2. tool.needsPermissions() ì²´í¬
  if (!tool.needsPermissions(input)) {
    return { result: true }
  }

  // 3. í”„ë¡œì íŠ¸ ì„¤ì • ì¡°íšŒ
  const allowedTools = getCurrentProjectConfig().allowedTools ?? []

  // 4. ë„êµ¬ë³„ ì²´í¬
  switch (tool) {
    case BashTool:
      return await bashToolHasPermission(...)
    case FileEditTool:
      return { result: !hasWritePermission(input.file_path) }
    default:
      return { result: allowedTools.includes(tool.name) }
  }
}
```

#### 3ë‹¨ê³„: BashTool ìƒì„¸ ì²´í¬

```typescript
export const bashToolHasPermission = async (...) => {
  // 1. ì•ˆì „ ëª…ë ¹ì–´ ì²´í¬
  if (SAFE_COMMANDS.has(command)) {
    return { result: true }
  }

  // 2. ëª…ë ¹ì–´ ë¶„ë¦¬
  const subCommands = splitCommand(command)

  // 3. ëª…ë ¹ì–´ ì ‘ë‘ì‚¬ ì¶”ì¶œ
  const commandSubcommandPrefix = await getCommandSubcommandPrefix(command)

  // 4. ëª…ë ¹ì–´ ì£¼ì… íƒì§€
  if (commandSubcommandPrefix.commandInjectionDetected) {
    // ì •í™•í•œ ë§¤ì¹­ë§Œ í—ˆìš©
    return bashToolCommandHasExactMatchPermission(...)
  }

  // 5. ê° ì„œë¸Œì»¤ë§¨ë“œ ì²´í¬
  if (subCommands.every(subCmd => hasPermission(subCmd))) {
    return { result: true }
  }

  return { result: false }
}
```

#### 4ë‹¨ê³„: ì‚¬ìš©ì ìŠ¹ì¸ ìš”ì²­

```typescript
setToolUseConfirm({
  assistantMessage,
  tool,
  description,
  input,
  commandPrefix,
  riskScore: null,
  onAbort() {
    // ì·¨ì†Œ
    resolve({ result: false, message: REJECT_MESSAGE })
    toolUseContext.abortController.abort()
  },
  onAllow(type) {
    // ìŠ¹ì¸ (type: 'permanent' | 'temporary')
    if (type === 'permanent') {
      savePermission(tool, input, commandPrefix)
    }
    resolve({ result: true })
  },
  onReject() {
    // ê±°ë¶€
    resolve({ result: false, message: REJECT_MESSAGE })
    toolUseContext.abortController.abort()
  },
})
```

#### 5ë‹¨ê³„: ê¶Œí•œ ì €ì¥

```typescript
export async function savePermission(
  tool: Tool,
  input: { [k: string]: unknown },
  prefix: string | null,
): Promise<void> {
  const key = getPermissionKey(tool, input, prefix)

  // íŒŒì¼ í¸ì§‘ ë„êµ¬: ë©”ëª¨ë¦¬ì—ë§Œ ì €ì¥
  if (tool === FileEditTool || tool === FileWriteTool || tool === NotebookEditTool) {
    grantWritePermissionForOriginalDir()
    return
  }

  // ê¸°íƒ€ ë„êµ¬: í”„ë¡œì íŠ¸ ì„¤ì •ì— ì €ì¥
  const projectConfig = getCurrentProjectConfig()
  if (projectConfig.allowedTools.includes(key)) {
    return  // ì´ë¯¸ ì¡´ì¬
  }

  projectConfig.allowedTools.push(key)
  projectConfig.allowedTools.sort()
  saveCurrentProjectConfig(projectConfig)
}
```

**ê¶Œí•œ í‚¤ ìƒì„±:**
```typescript
function getPermissionKey(
  tool: Tool,
  input: { [k: string]: unknown },
  prefix: string | null,
): string {
  switch (tool) {
    case BashTool:
      if (prefix) {
        return `${BashTool.name}(${prefix}:*)`  // ì˜ˆ: "Bash(git:*)"
      }
      return `${BashTool.name}(${BashTool.renderToolUseMessage(input)})`
    default:
      return tool.name  // ì˜ˆ: "Edit"
  }
}
```

**ì €ì¥ ìœ„ì¹˜:**
- **íŒŒì¼ ë„êµ¬**: ì„¸ì…˜ ë©”ëª¨ë¦¬ (íœ˜ë°œì„±)
- **Bash ë„êµ¬**: `.kode.json` (ì˜êµ¬)
- **ê¸°íƒ€ ë„êµ¬**: `.kode.json` (ì˜êµ¬)

---

## íƒ€ì… ì •ì˜ ë° ìƒìˆ˜

### ê¶Œí•œ ê´€ë ¨ íƒ€ì…

```typescript
// PermissionMode.ts
export type PermissionMode =
  | 'default'
  | 'acceptEdits'
  | 'plan'
  | 'bypassPermissions'

export interface PermissionContext {
  mode: PermissionMode
  allowedTools: string[]
  allowedPaths: string[]
  restrictions: {
    readOnly: boolean
    requireConfirmation: boolean
    bypassValidation: boolean
  }
  metadata: {
    activatedAt?: string
    previousMode?: PermissionMode
    transitionCount: number
  }
}

export interface ModeConfig {
  name: PermissionMode
  label: string
  icon: string
  color: string
  description: string
  allowedTools: string[]
  restrictions: {
    readOnly: boolean
    requireConfirmation: boolean
    bypassValidation: boolean
  }
}
```

### ë„êµ¬ ì»¨í…ìŠ¤íŠ¸ íƒ€ì…

```typescript
// Tool.ts
export interface ToolUseContext {
  messageId: string | undefined
  agentId?: string
  safeMode?: boolean
  abortController: AbortController
  readFileTimestamps: { [filePath: string]: number }
  options?: {
    commands?: any[]
    tools?: any[]
    verbose?: boolean
    slowAndCapableModel?: string
    safeMode?: boolean
    forkNumber?: number
    messageLogName?: string
    maxThinkingTokens?: any
    isKodingRequest?: boolean
    kodingContext?: string
    isCustomCommand?: boolean
  }
  responseState?: {
    previousResponseId?: string
    conversationId?: string
  }
}

export interface ValidationResult {
  result: boolean
  message?: string
  errorCode?: number
  meta?: any
}
```

### ë©”ì‹œì§€ íƒ€ì…

```typescript
// conversation.ts
export type Message = UserMessage | AssistantMessage | ProgressMessage

export interface UserMessage {
  message: MessageParam
  type: 'user'
  uuid: UUID
  toolUseResult?: any
  options?: {
    isKodingRequest?: boolean
    kodingContext?: string
  }
}

export interface AssistantMessage {
  costUSD: number
  durationMs: number
  message: APIAssistantMessage
  type: 'assistant'
  uuid: UUID
  isApiErrorMessage?: boolean
}
```

### ë¡œê·¸ íƒ€ì…

```typescript
// logs.ts
export interface SerializedMessage {
  type: 'user' | 'assistant' | 'progress'
  uuid: UUID
  message?: {
    content: string | Array<{ type: string; text?: string }>
    role: 'user' | 'assistant' | 'system'
  }
  costUSD?: number
  durationMs?: number
  timestamp: string
  cwd?: string
  userType?: string
  sessionId?: string
  version?: string
}
```

### ìƒìˆ˜ ì •ì˜

```typescript
// product.ts
export const PRODUCT_NAME = 'Kode'
export const PRODUCT_URL = 'https://github.com/shareAI-lab/Anykode'
export const PROJECT_FILE = 'AGENTS.md'
export const PRODUCT_COMMAND = 'kode'
export const CONFIG_BASE_DIR = '.kode'
export const CONFIG_FILE = '.kode.json'

// oauth.ts (ë¹„í™œì„±í™”)
const PROD_OAUTH_CONFIG = {
  REDIRECT_PORT: 54545,
  MANUAL_REDIRECT_URL: '/oauth/code/callback',
  SCOPES: ['org:create_api_key', 'user:profile'] as const,
  AUTHORIZE_URL: '',  // ë¹„ì–´ìˆìŒ
  TOKEN_URL: '',
  API_KEY_URL: '',
  SUCCESS_URL: '',
  CLIENT_ID: '',
} as const
```

---

## ë³´ì•ˆ ë©”ì»¤ë‹ˆì¦˜ ìš”ì•½

### ë‹¤ì¸µ ë°©ì–´ (Defense in Depth)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ê³„ì¸µ 1: ê¶Œí•œ ëª¨ë“œ (PermissionContext)                    â”‚
â”‚ - default/acceptEdits/plan/bypassPermissions             â”‚
â”‚ - ëª¨ë“œë³„ ë„êµ¬ ì œí•œ ë° ì œì•½ì‚¬í•­                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ê³„ì¸µ 2: ë„êµ¬ ê¶Œí•œ ì²´í¬ (hasPermissionsToUseTool)         â”‚
â”‚ - Safe Mode ì²´í¬                                         â”‚
â”‚ - needsPermissions() ì²´í¬                                â”‚
â”‚ - í”„ë¡œì íŠ¸ ì„¤ì • allowedTools í™•ì¸                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ê³„ì¸µ 3: ë„êµ¬ë³„ ìƒì„¸ ê²€ì¦                                  â”‚
â”‚ - Bash: ëª…ë ¹ì–´ ì£¼ì… íƒì§€, ì„œë¸Œì»¤ë§¨ë“œ ê²€ì¦                 â”‚
â”‚ - File: ê²½ë¡œ ê²€ì¦, ì›ë˜ ì‘ì—… ë””ë ‰í† ë¦¬ ì œí•œ                â”‚
â”‚ - ê¸ˆì§€ ëª…ë ¹ì–´ í•„í„°ë§                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ê³„ì¸µ 4: íŒŒì¼ì‹œìŠ¤í…œ ê¶Œí•œ (filesystem.ts)                   â”‚
â”‚ - ì½ê¸°/ì“°ê¸° ë””ë ‰í† ë¦¬ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸                          â”‚
â”‚ - ì ˆëŒ€ ê²½ë¡œ ê²€ì¦                                          â”‚
â”‚ - ì„œë¸ŒíŒ¨ìŠ¤ ì²´í¬                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ê³„ì¸µ 5: ì‚¬ìš©ì ìŠ¹ì¸ (UI)                                  â”‚
â”‚ - ê¶Œí•œ ì—†ëŠ” ì‘ì—…ì‹œ ì‚¬ìš©ìì—ê²Œ í™•ì¸                         â”‚
â”‚ - temporary/permanent ìŠ¹ì¸                               â”‚
â”‚ - Abort ì‹ í˜¸ ì²˜ë¦¬                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì£¼ìš” ë³´ì•ˆ ì›ì¹™

1. **Fail Closed (ì•ˆì „ ì¸¡ìœ¼ë¡œ ì‹¤íŒ¨)**
   - ê¶Œí•œ ë¶ˆí™•ì‹¤ì‹œ ê±°ë¶€
   - ëª…ë ¹ì–´ ì£¼ì… ì˜ì‹¬ì‹œ ì •í™•í•œ ë§¤ì¹­ë§Œ í—ˆìš©
   - ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ì‹œ ê±°ë¶€

2. **ìµœì†Œ ê¶Œí•œ ì›ì¹™ (Least Privilege)**
   - í•„ìš”í•œ ìµœì†Œí•œì˜ ê¶Œí•œë§Œ ë¶€ì—¬
   - íŒŒì¼ ë„êµ¬ëŠ” ì„¸ì…˜ ë©”ëª¨ë¦¬ì—ë§Œ ì €ì¥ (ì˜êµ¬ ì €ì¥ ì•ˆ í•¨)
   - ì›ë˜ ì‘ì—… ë””ë ‰í† ë¦¬ ë‚´ë¶€ë¡œ ì œí•œ

3. **ì‚¬ìš©ì ì œì–´ (User Control)**
   - ëª¨ë“  ë¯¼ê°í•œ ì‘ì—…ì€ ì‚¬ìš©ì ìŠ¹ì¸ í•„ìš”
   - temporary/permanent ì„ íƒ ê°€ëŠ¥
   - ì–¸ì œë“ ì§€ Abort ê°€ëŠ¥

4. **íˆ¬ëª…ì„± (Transparency)**
   - ëª¨ë“  ê¶Œí•œ ìš”ì²­ ë¡œê¹…
   - ë¹„ìš© ì¶”ì  ë° í‘œì‹œ
   - ëª…í™•í•œ ê¶Œí•œ ìš”ì²­ ë©”ì‹œì§€

5. **ì•…ì„± ì½”ë“œ ë°©ì§€**
   - ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ì—ì„œ ì•…ì„± ì½”ë“œ ì‘ì„±/ê°œì„  ê±°ë¶€
   - íŒŒì¼ëª…/ë””ë ‰í† ë¦¬ êµ¬ì¡° ê¸°ë°˜ íƒì§€
   - ê¸ˆì§€ ëª…ë ¹ì–´ ëª©ë¡

---

## ê²°ë¡ 

Kode-CLIì˜ ê¶Œí•œ ë° ë³´ì•ˆ ì‹œìŠ¤í…œì€ **ë‹¤ì¸µ ë°©ì–´, Fail Closed, ìµœì†Œ ê¶Œí•œ ì›ì¹™**ì„ ê¸°ë°˜ìœ¼ë¡œ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.

**í•µì‹¬ ê°•ì :**
- âœ… **ì„¸ë°€í•œ ê¶Œí•œ ì œì–´**: ë„êµ¬ë³„, ëª…ë ¹ì–´ë³„, ê²½ë¡œë³„ ê¶Œí•œ ê´€ë¦¬
- âœ… **ëª…ë ¹ì–´ ì£¼ì… ë°©ì§€**: Bash ë„êµ¬ì˜ ì •êµí•œ ê²€ì¦ ë©”ì»¤ë‹ˆì¦˜
- âœ… **ì‚¬ìš©ì ì¤‘ì‹¬**: ëª¨ë“  ë¯¼ê°í•œ ì‘ì—…ì€ ì‚¬ìš©ì ìŠ¹ì¸ í•„ìš”
- âœ… **íˆ¬ëª…í•œ ë¹„ìš© ì¶”ì **: API í˜¸ì¶œ ë¹„ìš© ë° ì‹œê°„ ëª¨ë‹ˆí„°ë§
- âœ… **ì„¸ì…˜ ê²©ë¦¬**: íŒŒì¼ì‹œìŠ¤í…œ ê¶Œí•œì€ ì„¸ì…˜ë§ˆë‹¤ ë¦¬ì…‹

**ê°œì„  ê°€ëŠ¥ ì˜ì—­:**
- âš ï¸ **API í‚¤ ê²€ì¦**: í˜„ì¬ ë¹„í™œì„±í™” ìƒíƒœ
- âš ï¸ **Sentry í†µí•©**: ìŠ¤í…ë§Œ êµ¬í˜„
- âš ï¸ **ê¶Œí•œ ê°ì‚¬**: ê¶Œí•œ ë¶€ì—¬/ì‚¬ìš© ì´ë ¥ ì¶”ì  ë¶€ì¡±

**ë³´ì•ˆ ëª¨ë²” ì‚¬ë¡€:**
1. Safe ModeëŠ” í•­ìƒ í™œì„±í™” ê¶Œì¥
2. bypassPermissions ëª¨ë“œëŠ” ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ì—ì´ì „íŠ¸ì—ë§Œ ì‚¬ìš©
3. í”„ë¡œì íŠ¸ ì„¤ì • (.kode.json)ì€ ë²„ì „ ê´€ë¦¬ì— í¬í•¨
4. ì›ë˜ ì‘ì—… ë””ë ‰í† ë¦¬ ì™¸ë¶€ ì ‘ê·¼ í•„ìš”ì‹œ ì‹¬ë³¼ë¦­ ë§í¬ í™œìš© ê¸ˆì§€
5. ë¯¼ê°í•œ ì‘ì—…ì€ temporary ìŠ¹ì¸ ì‚¬ìš© ê¶Œì¥

ì´ ì‹œìŠ¤í…œì€ **AI ì—ì´ì „íŠ¸ì˜ ììœ¨ì„±ê³¼ ì‚¬ìš©ìì˜ ì‹œìŠ¤í…œ ë³´ì•ˆ ì‚¬ì´ì˜ ê· í˜•**ì„ íš¨ê³¼ì ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤.
